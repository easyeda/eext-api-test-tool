<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>接口工具</title>
		<style>
			body {
				font-family: Arial, sans-serif;
			}
		</style>
		<script>
			const history = [];
			const maxHistory = 3;

			async function showDataProject() {
				const boards = await eda.dmt_Board.getAllBoardsInfo();
				const outputElement = document.getElementById('output');
				outputElement.innerHTML = ''; // 清空output元素

				for (const board of boards) {
					const boardDiv = document.createElement('div');
					boardDiv.innerHTML = `
                    <h3>Board Name: ${board.name}</h3>
                    <p>Parent Project UUID: ${board.parentProjectUuid}</p>

                    <p>PCB Name: ${board.pcb ? board.pcb.name : 'N/A'}</p>
                    <p>PCB UUID: ${board.pcb ? board.pcb.uuid : 'N/A'}</p>
                    
                    <p>SCH Name: ${board.schematic ? board.schematic.name : 'N/A'}</p>
                    <p>SCH UUID: ${board.schematic ? board.schematic.uuid : 'N/A'}</p>
                `;
					outputElement.appendChild(boardDiv);
				}
			}

			function invokeCommand(command) {
				try {
					// 解析命令格式为 "DMT_Folder.createFolder()"
					const match = command.match(/(\w+)\.(\w+)\(([^)]*)\)/);
					if (match) {
						const className = match[1];
						const methodName = match[2];
						const params = match[3] ? match[3].split(',').map((param) => param.trim()) : [];

						// 填充到对应的输入框中
						document.getElementById('className').value = className;
						document.getElementById('methodName').value = methodName;
						document.getElementById('params').value = params.length > 0 ? params.join(', ').replace(/"/g, "'") : '';

						// 更新历史记录
						updateHistory(`${className}.${methodName}(${params.join(', ')})`);
					} else {
						document.getElementById('output').textContent = '命令格式错误';
					}
				} catch (e) {
					console.log(e.message);
					document.getElementById('output').textContent = 'Error: ' + e.message;
				}
			}

			function invokeMethod() {
				let className = document.getElementById('className').value;
				// 将类名中下划线前的大写字母转换为小写
				className = className.replace(/([A-Z]+)(?=_)/g, (match) => match.toLowerCase());

				let methodName = document.getElementById('methodName').value;
				// 将方法名后面的括号去掉
				methodName = methodName.replace(/\(\)$/, '');

				// 使用JSON.parse来解析参数字符串，这样可以保留单引号
				let params;
				try {
					params = document.getElementById('params').value
						? JSON.parse('[' + document.getElementById('params').value.replace(/'/g, '"') + ']')
						: [];
				} catch (e) {
					console.log(e.message);
					document.getElementById('output').textContent = 'Error: 参数格式错误';
					return;
				}

				try {
					// 获取类和方法
					let cls = eda[className];
					let method = cls ? cls[methodName] : null;

					if (method && typeof method === 'function') {
						// 直接使用params数组作为参数调用方法
						let result = method.apply(cls, params);

						// 处理异步函数
						if (typeof result?.then === 'function') {
							result
								.then(function (value) {
									// 使用JSON.stringify将对象转换为字符串
									document.getElementById('output').textContent =
										'[异步函数]返回值:' + JSON.stringify(value, null, 2) + '类型: ' + typeof value;
									console.log(value);
								})
								.catch(function (error) {
									console.log(error.message);
									document.getElementById('output').textContent = 'Error: ' + error.message;
								});
						} else {
							// 同步函数的结果直接显示
							// 使用JSON.stringify将对象转换为字符串
							document.getElementById('output').textContent = '返回值:' + JSON.stringify(result, null, 2) + '类型: ' + typeof result;
							console.log(result);
						}
					} else {
						document.getElementById('output').textContent = '方法调用有误';
					}
				} catch (e) {
					console.log(e.message);
					document.getElementById('output').textContent = 'Error: ' + e.message;
				}
				// 更新历史记录
				updateHistory(`${className}.${methodName}(${params.join(', ')})`);
			}

			function updateOutput(prefix, output, type) {
				let outputElement = document.getElementById('output');
				outputElement.textContent = prefix + output + (type ? ' 类型: ' + type : '');
				console.log(output);
			}

			function updateHistory(command) {
				// 添加新的历史记录并移除超出限制的旧记录
				history.unshift(command);
				if (history.length > maxHistory) {
					history.pop();
				}

				// 显示历史记录
				let historyDiv = document.getElementById('history');
				historyDiv.innerHTML = ''; // 清空历史记录div
				history.forEach((item) => {
					let p = document.createElement('p');
					p.textContent = item;
					historyDiv.appendChild(p);
				});
			}
		</script>
	</head>
	<body>
		<h2>接口测试工具</h2>
		<label for="commandInput">指令:</label>
		<input type="text" id="commandInput" placeholder="DMT_Folder.createFolder()" oninput="invokeCommand(this.value)" />
		<br /><br />
		<label for="className">类名:</label>
		<input type="text" id="className" placeholder="sys_I18n" />
		<br /><br />
		<label for="methodName">方法名:</label>
		<input type="text" id="methodName" placeholder="getCurrentLanguage" />
		<br /><br />
		<label for="params">参数:</label>
		<input type="text" id="params" placeholder="" />
		<br /><br />
		<button onclick="invokeMethod()">调用</button>
		<button onclick="showDataProject()">工程信息</button>

		<h3>输出:</h3>
		<div id="output"></div>
		<h3>记录:</h3>
		<div id="history"></div>
	</body>
</html>
